<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BabyMonitor â€” wizualizacja CSV</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    body{padding:16px}
    .uploader{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .uploader input[type=file]{padding:6px;background:#0f172a;border:1px solid #1e2a41;border-radius:8px;color:#e5eefb}
    .grid{display:grid;grid-template-columns:1fr;gap:16px;max-width:1100px}
  </style>
  <script type="module">
    import * as Plot from "https://cdn.jsdelivr.net/npm/@observablehq/plot@0.6/+esm";
    import {csvParse} from "https://cdn.jsdelivr.net/npm/d3-dsv@3/+esm";

    const up = document.getElementById("file");
    const preview = document.getElementById("preview");
    const chartRR = document.getElementById("chart-rr");
    const chartHist = document.getElementById("chart-hist");
    const chartPresence = document.getElementById("chart-presence");

    up.addEventListener("change", async () => {
      const file = up.files?.[0];
      if (!file) return;
      const text = await file.text();
      const raw = csvParse(text);

      const data = raw.map(r => ({
        ts: new Date(r.ts),
        device_id: r.device_id,
        respiration_rate_bpm: r.respiration_rate_bpm === "" ? null : +r.respiration_rate_bpm,
        presence: r.presence?.toLowerCase?.() === "true",
        event: r.event || ""
      })).filter(d => !Number.isNaN(d.respiration_rate_bpm) && d.ts.toString() !== "Invalid Date");

      const window = 300;
      const roll = new Array(data.length).fill(null);
      let sum = 0, q = [];
      for (let i=0;i<data.length;i++){
        const v = data[i].respiration_rate_bpm ?? 0;
        q.push(v); sum += v;
        if (q.length>window) sum -= q.shift();
        roll[i] = q.length ? sum/q.length : null;
      }
      const withRoll = data.map((d,i)=>({...d, rr_roll5m: roll[i]}));

      const events = withRoll.filter(d=>d.event);

      const width = Math.min(1000, document.body.clientWidth-32);
      const plotRR = Plot.plot({
        width, height: 260,
        marginLeft: 48, marginRight: 16,
        x: {label: "czas"}, y: {label: "oddechy/min"},
        marks: [
          Plot.ruleX(events, {x: "ts", stroke: "#888", title: d=>d.event}),
          Plot.line(withRoll, {x: "ts", y: "respiration_rate_bpm", tip: true}),
          Plot.line(withRoll, {x: "ts", y: "rr_roll5m", strokeDash: [4,3], title: d=>`Å›rednia 5 min: ${d.rr_roll5m?.toFixed?.(1)}`})
        ]
      });
      chartRR.replaceChildren(plotRR);

      const present = withRoll.filter(d=>d.presence && (d.respiration_rate_bpm??0) > 0);
      const plotHist = Plot.plot({
        width, height: 220,
        x: {label: "oddechy/min"}, y: {label: "liczba prÃ³bek"},
        marks: [ Plot.rectY(present, Plot.binX({y: "count"}, {x: "respiration_rate_bpm", interval: 1})), Plot.ruleY([0]) ]
      });
      chartHist.replaceChildren(plotHist);

      const plotPresence = Plot.plot({
        width, height: 100,
        x: {label:"czas"}, y: {domain:[0,1], ticks:[0,1], tickFormat:d=>d?"obecny":"brak"},
        marks: [
          Plot.dot(withRoll, {x:"ts", y:d=>d.presence?1:0, r: 1.5})
        ]
      });
      chartPresence.replaceChildren(plotPresence);

      const total = withRoll.length;
      const presentCount = withRoll.filter(d=>d.presence).length;
      preview.textContent = `ZaÅ‚adowano ${total} prÃ³bek; presence==true: ${presentCount} (${Math.round(100*presentCount/total)}%), zdarzenia: ${events.length}`;
    });
  </script>
</head>
<body>
  <h1>ðŸ“Š BabyMonitor â€” wizualizacja CSV (Observable Plot)</h1>
  <div class="uploader">
    <label for="file">Wybierz plik CSV</label>
    <input id="file" type="file" accept=".csv,text/csv" />
    <span id="preview" style="color:#9db4d1"></span>
  </div>
  <div class="grid">
    <section>
      <h2>Oddechy/min (z Å›redniÄ… kroczÄ…cÄ… 5 min)</h2>
      <div id="chart-rr"></div>
    </section>
    <section>
      <h2>RozkÅ‚ad RR (gdy obecnoÅ›Ä‡==true)</h2>
      <div id="chart-hist"></div>
    </section>
    <section>
      <h2>ObecnoÅ›Ä‡</h2>
      <div id="chart-presence"></div>
    </section>
  </div>
</body>
</html>
